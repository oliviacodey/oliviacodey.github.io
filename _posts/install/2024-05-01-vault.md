---
title: Install Vault
date: 2024-05-20
categories: [k8s,Install]
tags: [k8s,install,vault]     # TAG names should always be lowercase
---

## Vault by HashiCorp

Vault secures, stores, and tightly controls access to tokens, passwords, certificates, API keys, and other secrets critical in modern computing.

## Install

```bash
podman run -d --cap-add=IPC_LOCK --label "io.containers.autoupdate=registry" --name vault --net=mac-vlan --hostname=vault.domain.com --ip 192.168.0.37 -v vault:/vault/config.d -p 8200:8200 docker.io/hashicorp/vault:latest
```

## Enter the Vault

Start the shell in vault

```bash
podman logs vault |grep Token # shows the default root token
podman exec -it vault /bin/sh

```

Login to the vault

```bash
export VAULT_ADDR='http://127.0.0.1:8200'
vault login "token here"
vault token lookup
```

Create the vault

```bash
vault operator init
```

Unseal the vault

```bash
vault operator unseal # Uses Shamir's secret sharing
```

### Configure Kubernetes authentication

Vault provides a Kubernetes authentication method that enables clients to authenticate with a Kubernetes Service Account Token.

```bash
vault auth enable kubernetes
```

On the k8s cluster

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: vault-token-g955r
  annotations:
    kubernetes.io/service-account.name: vault
type: kubernetes.io/service-account-token
```

```bash
TOKEN_REVIEW_JWT=$(kubectl get secret vault-token-g955r --output='go-template={{ .data.token }}' | base64 --decode)
KUBE_CA_CERT=$(kubectl config view --raw --minify --flatten --output='jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode)
KUBE_HOST=$(kubectl config view --raw --minify --flatten --output='jsonpath={.clusters[].cluster.server}') # or export KUBE_HOST="https://kube:6443"
```

> Get the cluster issuer by running: kubectl get --raw /.well-known/openid-configuration | jq -r .issuer
{: .prompt-tip }

Move these values to the Vault server and run
This way didnt work. The only ways was by uploading the ca-cert in the gui.

```bash
vault write auth/kubernetes/config \
     token_reviewer_jwt=@/vault/config.d/jwt-token \
     kubernetes_host="$KUBE_HOST" \
     kubernetes_ca_cert=@/vault/config.d/kube-ca.pem \
     tls_skip_verify="true" \
     disable_local_ca_jwt="true"

# or

vault write auth/kubernetes/config \
     token_reviewer_jwt="$TOKEN_REVIEW_JWT" \
     kubernetes_host="$KUBE_HOST" \
     kubernetes_ca_cert="$KUBE_CA_CERT" \
     tls_skip_verify="true" \
     disable_local_ca_jwt="true" \
     issuer="\"https://kubernetes.default.svc.cluster.local\""
```

```bash
vault write auth/kubernetes/config \
  token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
  kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
  kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
  issuer="\"https://kubernetes.default.svc.cluster.local\""
```



Check out your config

```bash
vault read auth/kubernetes/config
```